// This is your Prisma schema file
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// EXISTING MODELS (Keep as is)
// ============================================================================
enum Role {
  ADMINISTRATOR
  USER
}

model User {
  id        String   @id @default(cuid())
  name      String
  email     String   @unique
  phone     String?  @unique
  role      Role     @default(USER)
  avatar    String?
  password  String? // Made optional for Google OAuth users
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Google OAuth fields
  googleId      String? @unique // Google user ID
  isGoogleUser  Boolean @default(false) // Flag to identify Google OAuth users
  emailVerified Boolean @default(false) // Email verification status

  // EXISTING RELATIONS
  refreshTokens RefreshToken[]

  // NEW RELATIONS - Service Catalog & Credit System
  creditBalance Int @default(0) // Credit balance in IDR (no decimals needed)
  totalTopUp    Int @default(0) // Total lifetime top-up in IDR
  totalSpent    Int @default(0) // Total lifetime spending in IDR

  subscriptions    Subscription[]
  transactions     Transaction[]
  CouponRedemption CouponRedemption[]

  // Support Ticket Relations
  tickets           Ticket[]
  ticketMessages    TicketMessage[]
  ticketAttachments TicketAttachment[]

  @@map("users")
}

model RefreshToken {
  id        String   @id @default(cuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("refresh_tokens")
}

// ============================================================================
// SERVICE CATALOG MODELS
// ============================================================================

// Service Categories (Development Tools, CMS, etc.)
model ServiceCategory {
  id          String   @id @default(cuid())
  name        String   @unique // "Development Tools", "CMS"
  slug        String   @unique // "dev-tools", "cms"
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  services Service[]

  @@map("service_categories")
}

// Service Templates (N8N, Ghost, etc.)
model Service {
  id              String  @id @default(cuid())
  name            String // "N8N Automation", "Ghost Blog"
  slug            String  @unique // "n8n-automation", "ghost-blog"
  description     String?
  longDescription String?
  icon            String?
  version         String // "latest", "1.0.0"

  // Kubernetes Configuration
  dockerImage String // "n8nio/n8n:latest"
  defaultPort Int    @default(3000)

  categoryId String
  category   ServiceCategory @relation(fields: [categoryId], references: [id])

  envTemplate   Json? // Default environment variables
  tags          String[] // ["automation", "workflow"]
  documentation String?

  isActive   Boolean @default(true)
  isPublic   Boolean @default(true)
  isFeatured Boolean @default(false)
  sortOrder  Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  plans         ServicePlan[]
  subscriptions Subscription[]
  Coupon        Coupon[]

  @@map("services")
}

// Service Plans with Quota System
enum PlanType {
  FREE
  BASIC
  PRO
  PREMIUM
  ENTERPRISE
}

model ServicePlan {
  id        String  @id @default(cuid())
  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  name        String // "Free", "Basic", "Pro"
  planType    PlanType
  description String?

  // Pricing
  monthlyPrice Int // Monthly price in IDR (no decimals needed)

  // Resource Allocations
  cpuMilli  Int // CPU in millicores
  memoryMb  Int // Memory in MB
  storageGb Int // Storage in GB
  bandwidth Int @default(0) // Monthly bandwidth in GB

  // SIMPLIFIED QUOTA SYSTEM - Server Resource Management
  totalQuota Int // Total available slots
  usedQuota  Int @default(0) // Currently used slots
  // availableQuota = totalQuota - usedQuota (calculated in code)

  features            Json? // Array of features
  maxInstancesPerUser Int   @default(1)
  maxDomains          Int   @default(1)

  isActive  Boolean @default(true)
  isPopular Boolean @default(false)
  sortOrder Int     @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]

  @@unique([serviceId, planType])
  @@map("service_plans")
}

// ============================================================================
// SUBSCRIPTION & BILLING MODELS
// ============================================================================

enum SubscriptionStatus {
  ACTIVE
  SUSPENDED
  CANCELLED
  EXPIRED
  PENDING_UPGRADE
  PENDING_PAYMENT
}

model Subscription {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id])

  planId String
  plan   ServicePlan @relation(fields: [planId], references: [id])

  status SubscriptionStatus @default(ACTIVE)

  // Billing Information
  startDate   DateTime  @default(now())
  endDate     DateTime // Next billing date
  lastBilled  DateTime?
  nextBilling DateTime?

  // Credit-based Billing
  monthlyPrice     Int // Cached price in IDR
  lastChargeAmount Int? // Last charge amount in IDR
  failedCharges    Int  @default(0)

  // Upgrade System
  previousPlanId String?
  upgradeDate    DateTime?
  downgradeTo    String?

  autoRenew      Boolean   @default(true)
  gracePeriodEnd DateTime? // When service will be suspended

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  instances        ServiceInstance[]
  transactions     Transaction[]
  CouponRedemption CouponRedemption[]

  // BUSINESS RULE: One active subscription per user per service (enforced in application logic)
  // Removed unique constraint to allow subscription history and re-subscriptions
  @@map("subscriptions")
}

// ============================================================================
// CREDIT & TRANSACTION SYSTEM
// ============================================================================

enum TransactionType {
  TOP_UP // User top-up credit
  SUBSCRIPTION // Monthly subscription charge
  UPGRADE // Upgrade cost difference
  REFUND // Refund from cancellation
  ADMIN_ADJUSTMENT // Manual admin adjustment
  COUPON_REDEMPTION // Coupon redemption for credit
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  MIDTRANS_BANK_TRANSFER // BCA, BNI, BRI, Mandiri
  MIDTRANS_E_WALLET // GoPay, OVO, DANA, LinkAja
  MIDTRANS_CREDIT_CARD // Visa, Mastercard
  MIDTRANS_QRIS // QRIS payment
  ADMIN_MANUAL // Manual admin adjustment
  COUPON_REDEMPTION // Coupon redemption payment method
}

model Transaction {
  id       String @id @default(cuid())
  customId String @unique // Custom transaction ID format: TXMP-101, TXMP-102, etc.
  userId   String
  user     User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  type   TransactionType
  status TransactionStatus @default(PENDING)
  amount Int // Amount in IDR (no decimals needed)

  // Balance Information
  balanceBefore Int // Balance before transaction in IDR
  balanceAfter  Int // Balance after transaction in IDR

  // Payment Information
  paymentMethod    PaymentMethod?
  paymentReference String?
  paymentProof     String?

  subscriptionId String?
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  description String
  metadata    Json?

  processedBy String?
  adminNotes  String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  completedAt DateTime?

  couponRedemption CouponRedemption?

  @@map("transactions")
}

// ============================================================================
// SERVICE INSTANCES & KUBERNETES
// ============================================================================

enum InstanceStatus {
  PENDING
  PROVISIONING
  RUNNING
  STOPPED
  ERROR
  TERMINATED
  MAINTENANCE
  RESTARTING
  STOPPING
  STARTING
}

model ServiceInstance {
  id             String       @id @default(cuid())
  subscriptionId String
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // NOTE: Service information is accessed via subscription.plan.service
  // This creates a cleaner architecture where instances belong only to subscriptions

  // Instance Configuration
  name      String
  subdomain String @unique // "myapp.minispod.com"

  // Kubernetes Information
  namespace      String // K8s namespace
  podName        String?
  serviceName    String?
  ingressName    String?
  deploymentName String?

  status          InstanceStatus @default(PENDING)
  healthStatus    String?
  lastHealthCheck DateTime?

  envVars      Json?
  customDomain String?
  sslEnabled   Boolean @default(false)

  // Resource Usage (cached from K8s)
  cpuUsage     Decimal? @db.Decimal(5, 2)
  memoryUsage  Decimal? @db.Decimal(8, 2)
  storageUsage Decimal? @db.Decimal(8, 2)

  publicUrl String?
  adminUrl  String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastStarted DateTime?
  lastStopped DateTime?

  @@map("service_instances")
}

// ============================================================================
// COUPON SYSTEM
// ============================================================================

enum CouponType {
  CREDIT_TOPUP // Add credit to wallet (billing page)
  SUBSCRIPTION_DISCOUNT // Discount on subscription (checkout page)
  FREE_SERVICE // Free service redemption
  WELCOME_BONUS // Welcome bonus for new users (auto-applied)
}

enum CouponDiscountType {
  FIXED_AMOUNT // Fixed IDR amount
  PERCENTAGE // Percentage discount
}

enum CouponStatus {
  ACTIVE
  EXPIRED
  DISABLED
  USED_UP
}

model Coupon {
  id          String  @id @default(cuid())
  code        String  @unique // "WELCOME50K", "SAVE20", "FREEN8N"
  name        String // "Welcome Bonus", "20% Off", "Free N8N"
  description String?

  type   CouponType
  status CouponStatus @default(ACTIVE)

  // Value Configuration
  creditAmount    Int? // For CREDIT_TOPUP and FIXED_AMOUNT discounts
  discountType    CouponDiscountType? // For SUBSCRIPTION_DISCOUNT
  discountPercent Int? // Percentage discount (1-100)

  // Usage Limits
  maxUses        Int @default(1) // Total usage limit
  usedCount      Int @default(0) // Current usage count
  maxUsesPerUser Int @default(1) // Per-user usage limit

  // Service Restrictions (optional)
  serviceId String? // Restrict to specific service
  service   Service?  @relation(fields: [serviceId], references: [id])
  planType  PlanType? // Restrict to specific plan types

  // Validity Period
  validFrom  DateTime  @default(now())
  validUntil DateTime?

  // Admin Information
  createdBy String // Admin user ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  redemptions CouponRedemption[]

  @@map("coupons")
}

model CouponRedemption {
  id String @id @default(cuid())

  couponId String
  coupon   Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Redemption Details
  redemptionType CouponType // Type at time of redemption
  creditAmount   Int? // Credit amount redeemed (for CREDIT_TOPUP)
  discountAmount Int? // Discount amount applied (for SUBSCRIPTION_DISCOUNT)

  // Related Records
  transactionId String?      @unique // Link to transaction record (for CREDIT_TOPUP)
  transaction   Transaction? @relation(fields: [transactionId], references: [id])

  subscriptionId String? // Link to subscription (for discounts/free service)
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id])

  metadata Json? // Additional redemption data

  redeemedAt DateTime @default(now())

  @@unique([couponId, userId]) // Prevent duplicate redemptions per user
  @@map("coupon_redemptions")
}

// ============================================================================
// SUPPORT TICKET SYSTEM
// ============================================================================

enum TicketStatus {
  OPEN
  IN_PROGRESS
  CLOSED
}

model Ticket {
  id           String       @id @default(cuid())
  ticketNumber Int          @unique @default(autoincrement()) // Auto-increment: #001, #002, etc.
  subject      String
  description  String
  status       TicketStatus @default(OPEN)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  messages    TicketMessage[]
  attachments TicketAttachment[]

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  closedAt  DateTime?
  closedBy  String? // Admin who closed the ticket

  @@map("tickets")
}

model TicketMessage {
  id           String  @id @default(cuid())
  content      String
  isAdminReply Boolean @default(false)

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  authorId String
  author   User   @relation(fields: [authorId], references: [id])

  attachments TicketAttachment[]

  createdAt DateTime @default(now())

  @@map("ticket_messages")
}

model TicketAttachment {
  id         String @id @default(cuid())
  filename   String // Original filename
  storedName String // Stored filename (UUID-based)
  filePath   String // Full file path
  fileSize   Int // File size in bytes
  mimeType   String // MIME type (image/jpeg, image/png, etc.)

  ticketId String?
  ticket   Ticket? @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  messageId String?
  message   TicketMessage? @relation(fields: [messageId], references: [id], onDelete: Cascade)

  uploadedBy String
  uploader   User   @relation(fields: [uploadedBy], references: [id])

  createdAt DateTime @default(now())

  @@map("ticket_attachments")
}

// ============================================================================
// QUOTA MANAGEMENT - SIMPLIFIED (No QuotaLog needed for MVP)
// ============================================================================
// Quota tracking is handled directly in ServicePlan model
// with simple totalQuota and usedQuota fields
